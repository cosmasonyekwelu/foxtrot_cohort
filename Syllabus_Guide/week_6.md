# Django Web Development Course - Week 6: Database Models

## Course Description
This course provides a comprehensive introduction to Django, a high-level Python web framework that enables rapid development of secure and maintainable websites. Students will learn to build dynamic web applications from scratch using Django's powerful components and best practices.

## Module 1: About Database Models

### What are Database Models?
Database models in Django are Python classes that define the structure of your database tables. They serve as the single, definitive source of information about your data, containing the essential fields and behaviors of the data you're storing.

**Key Concepts:**
- **Abstraction**: Models abstract away SQL details
- **ORM**: Object-Relational Mapping translates Python to SQL
- **Validation**: Built-in data validation
- **Relationships**: Define relationships between tables
- **Migrations**: Handle database schema changes

```python
# Example: Basic model structure
from django.db import models

class User(models.Model):
    # Field definitions
    name = models.CharField(max_length=100)
    email = models.EmailField()
    created_at = models.DateTimeField(auto_now_add=True)
    
    # Methods
    def __str__(self):
        return self.name
```

## Module 2: Configuring Django for Database Access

### Database Configuration

```python
# settings.py - Database configuration
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Alternative database configurations
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydatabase',
        'USER': 'mydatabaseuser',
        'PASSWORD': 'mypassword',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}

# MySQL configuration
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'mydatabase',
        'USER': 'mydatabaseuser',
        'PASSWORD': 'mypassword',
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
        },
    }
}
```

### Database Connection Settings

```python
# Additional database settings
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mydatabase',
        'USER': 'myuser',
        'PASSWORD': 'mypassword',
        'HOST': 'localhost',
        'PORT': '5432',
        'CONN_MAX_AGE': 600,  # Connection timeout in seconds
        'OPTIONS': {
            'connect_timeout': 10,
        },
        'TEST': {
            'NAME': 'test_mydatabase',  # Test database name
        }
    }
}

# Multiple database configuration
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    },
    'users': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'users_db',
        'USER': 'users_user',
        'PASSWORD': 'password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}

# Database router for multiple databases
class AuthRouter:
    """
    A router to control all database operations on models in the
    auth and contenttypes applications.
    """
    def db_for_read(self, model, **hints):
        if model._meta.app_label == 'auth':
            return 'users'
        return None

    def db_for_write(self, model, **hints):
        if model._meta.app_label == 'auth':
            return 'users'
        return None

# Add to settings.py
DATABASE_ROUTERS = ['path.to.AuthRouter']
```

## Module 3: Database Migrations

### Understanding Migrations
Migrations are Django's way of propagating changes you make to your models (adding a field, deleting a model, etc.) into your database schema.

```bash
# Migration commands
python manage.py makemigrations      # Create new migrations
python manage.py migrate            # Apply migrations to database
python manage.py showmigrations     # Show migration status
python manage.py sqlmigrate app_name migration_number  # Show SQL for migration
python manage.py migrate --fake     # Mark migration as applied without running
python manage.py migrate --plan     # Show migration plan
```

### Migration Examples

```python
# Example migration workflow
# 1. Create initial model
class Book(models.Model):
    title = models.CharField(max_length=200)
    author = models.CharField(max_length=100)
    published_date = models.DateField()

# 2. Generate migration
# bash: python manage.py makemigrations

# 3. Check generated migration file
"""
# Generated by Django 3.2 on 2023-01-01 12:00
from django.db import migrations, models

class Migration(migrations.Migration):
    initial = True
    dependencies = []
    operations = [
        migrations.CreateModel(
            name='Book',
            fields=[
                ('id', models.AutoField(auto_created=True, 
                 primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('author', models.CharField(max_length=100)),
                ('published_date', models.DateField()),
            ],
        ),
    ]
"""

# 4. Add new field to model
class Book(models.Model):
    title = models.CharField(max_length=200)
    author = models.CharField(max_length=100)
    published_date = models.DateField()
    isbn = models.CharField(max_length=13, blank=True)  # New field

# 5. Generate and run migration
# bash: python manage.py makemigrations
# bash: python manage.py migrate

# 6. Data migrations example
from django.db import migrations

def add_default_categories(apps, schema_editor):
    Category = apps.get_model('myapp', 'Category')
    Category.objects.create(name='Uncategorized')
    Category.objects.create(name='Featured')

class Migration(migrations.Migration):
    dependencies = [
        ('myapp', '0001_initial'),
    ]
    
    operations = [
        migrations.RunPython(add_default_categories),
    ]
```

## Module 4: Understanding Django Apps

### Django Apps Structure
A Django app is a Python package that contains related models, views, templates, and other code for a specific functionality.

```python
# Creating and configuring apps
# bash: python manage.py startapp myapp

# App structure
"""
myapp/
├── migrations/           # Database migration files
├── __init__.py
├── admin.py             # Admin interface configuration
├── apps.py              # App configuration
├── models.py            # Data models
├── tests.py             # Test cases
├── views.py             # View functions
└── urls.py              # App-specific URLs
"""

# apps.py - App configuration
from django.apps import AppConfig

class MyappConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'myapp'
    verbose_name = 'My Application'
    
    def ready(self):
        # Import signals when app is ready
        import myapp.signals

# settings.py - Registering apps
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp',  # Your custom app
]
```

### Best Practices for Apps

```python
# App organization principles
"""
- Each app should have a single, focused purpose
- Apps should be reusable across projects
- Keep apps small and specialized
- Use meaningful app names
"""

# Example: E-commerce project app structure
"""
ecommerce/
├── products/          # Product catalog app
├── cart/             # Shopping cart functionality
├── orders/           # Order processing
├── users/            # User profiles and authentication
├── payments/         # Payment processing
└── reviews/          # Product reviews
"""

# Reusable app structure
"""
reusable_app/
├── __init__.py
├── admin.py
├── apps.py
├── models.py
├── urls.py
├── views.py
├── templates/
│   └── reusable_app/
│       ├── base.html
│       └── detail.html
├── static/
│   └── reusable_app/
│       └── css/
├── migrations/
├── tests/
└── requirements.txt
"""
```

## Module 5: About Django Models

### Model Fundamentals
Django models are Python classes that subclass `django.db.models.Model`. Each attribute of the model represents a database field.

```python
from django.db import models
from django.urls import reverse
from django.utils import timezone

class Article(models.Model):
    # Basic fields
    title = models.CharField(max_length=200)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    published = models.BooleanField(default=False)
    
    # Relationships
    author = models.ForeignKey('auth.User', on_delete=models.CASCADE)
    categories = models.ManyToManyField('Category')
    
    # Model methods
    def __str__(self):
        return self.title
    
    def get_absolute_url(self):
        return reverse('article_detail', kwargs={'pk': self.pk})
    
    def was_published_recently(self):
        return self.created_at >= timezone.now() - timezone.timedelta(days=1)
    
    # Meta class for additional options
    class Meta:
        ordering = ['-created_at']
        verbose_name_plural = 'Articles'
```

## Module 6: Defining Django Models

### Complete Model Examples

```python
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator

class Author(models.Model):
    name = models.CharField(max_length=100)
    email = models.EmailField(unique=True)
    bio = models.TextField(blank=True)
    birth_date = models.DateField(null=True, blank=True)
    website = models.URLField(blank=True)
    
    def __str__(self):
        return self.name
    
    class Meta:
        ordering = ['name']

class Publisher(models.Model):
    name = models.CharField(max_length=200)
    address = models.TextField()
    phone = models.CharField(max_length=20)
    email = models.EmailField()
    
    def __str__(self):
        return self.name

class Book(models.Model):
    # Basic information
    title = models.CharField(max_length=200)
    isbn = models.CharField('ISBN', max_length=13, unique=True)
    description = models.TextField(blank=True)
    
    # Relationships
    author = models.ForeignKey(Author, on_delete=models.CASCADE, related_name='books')
    publisher = models.ForeignKey(Publisher, on_delete=models.SET_NULL, null=True)
    
    # Publication details
    publication_date = models.DateField()
    pages = models.PositiveIntegerField()
    language = models.CharField(max_length=50, default='English')
    
    # Pricing and inventory
    price = models.DecimalField(max_digits=10, decimal_places=2)
    stock_quantity = models.PositiveIntegerField(default=0)
    
    # Status fields
    available = models.BooleanField(default=True)
    featured = models.BooleanField(default=False)
    
    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.title} by {self.author.name}"
    
    @property
    def in_stock(self):
        return self.stock_quantity > 0
    
    def get_absolute_url(self):
        from django.urls import reverse
        return reverse('book_detail', kwargs={'pk': self.pk})
    
    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['title', 'author']),
            models.Index(fields=['publication_date']),
        ]
        constraints = [
            models.CheckConstraint(
                check=models.Q(price__gte=0),
                name='price_positive'
            )
        ]
```

## Module 7: Understanding Model Fields & Options

### Common Field Types

```python
from django.db import models
from django.core.validators import MinLengthValidator, RegexValidator

class Product(models.Model):
    # String fields
    name = models.CharField(
        max_length=100,
        help_text="Enter the product name",
        validators=[MinLengthValidator(2)]
    )
    slug = models.SlugField(unique=True)
    description = models.TextField(blank=True)
    
    # Numeric fields
    price = models.DecimalField(
        max_digits=10, 
        decimal_places=2,
        validators=[MinValueValidator(0)]
    )
    quantity = models.PositiveIntegerField(default=0)
    weight = models.FloatField(null=True, blank=True)
    
    # Boolean fields
    available = models.BooleanField(default=True)
    featured = models.BooleanField(default=False)
    
    # Date and time fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    release_date = models.DateField(null=True, blank=True)
    
    # Choice fields
    CATEGORY_CHOICES = [
        ('ELEC', 'Electronics'),
        ('CLO', 'Clothing'),
        ('BOOK', 'Books'),
        ('HOME', 'Home & Garden'),
    ]
    category = models.CharField(
        max_length=4,
        choices=CATEGORY_CHOICES,
        default='ELEC'
    )
    
    # File fields
    image = models.ImageField(
        upload_to='products/',
        null=True,
        blank=True,
        height_field='image_height',
        width_field='image_width'
    )
    image_height = models.PositiveIntegerField(null=True, blank=True)
    image_width = models.PositiveIntegerField(null=True, blank=True)
    
    # URL and email fields
    product_url = models.URLField(blank=True)
    support_email = models.EmailField(blank=True)
    
    # Custom validation
    sku = models.CharField(
        max_length=10,
        unique=True,
        validators=[
            RegexValidator(
                regex='^[A-Z]{3}-[0-9]{6}$',
                message='SKU must be in format: ABC-123456'
            )
        ]
    )
```

### Field Options and Parameters

```python
class FieldOptionsExample(models.Model):
    # Common field options
    required_field = models.CharField(
        max_length=100,
        verbose_name="Display Name",      # Human-readable name
        help_text="This field is required", # Help text
        error_messages={                  # Custom error messages
            'blank': "This field cannot be empty",
            'max_length': "Value is too long"
        }
    )
    
    optional_field = models.CharField(
        max_length=100,
        blank=True,           # Allows empty values in forms
        null=True,            # Allows NULL in database
        default='default',    # Default value
    )
    
    unique_field = models.CharField(
        max_length=100,
        unique=True,          # Ensures uniqueness in database
        db_index=True,        # Creates database index
    )
    
    # Date field options
    auto_now_field = models.DateTimeField(auto_now=True)     # Updated on save
    auto_now_add_field = models.DateTimeField(auto_now_add=True)  # Set on creation
    
    # ForeignKey options
    related_model = models.ForeignKey(
        'OtherModel',
        on_delete=models.CASCADE,        # Delete this when related object deleted
        related_name='examples',         # Reverse relation name
        related_query_name='example',    # Query name for reverse relations
        limit_choices_to={'active': True},  # Limit choices in forms
    )
    
    class Meta:
        # Table naming
        db_table = 'custom_table_name'
        
        # Ordering
        ordering = ['required_field', '-auto_now_add_field']
        
        # Indexes
        indexes = [
            models.Index(fields=['required_field', 'unique_field']),
        ]
        
        # Constraints
        constraints = [
            models.UniqueConstraint(
                fields=['required_field', 'unique_field'],
                name='unique_together_fields'
            ),
            models.CheckConstraint(
                check=models.Q(required_field__length__gt=0),
                name='required_field_not_empty'
            )
        ]
        
        # Permissions
        permissions = [
            ('can_publish', 'Can publish articles'),
        ]
        
        # Verbose names
        verbose_name = 'Field Example'
        verbose_name_plural = 'Field Examples'
```

## Module 8: Table Naming Conventions

### Django's Automatic Table Names

```python
# Default table naming
class Product(models.Model):
    name = models.CharField(max_length=100)
    # Table name: myapp_product

class CustomerOrder(models.Model):
    order_date = models.DateTimeField(auto_now_add=True)
    # Table name: myapp_customerorder

# Custom table names
class CustomTableName(models.Model):
    name = models.CharField(max_length=100)
    
    class Meta:
        db_table = 'custom_table_name'  # Explicit table name

# Multi-word table names
class UserProfile(models.Model):
    user = models.OneToOneField('auth.User', on_delete=models.CASCADE)
    bio = models.TextField()
    
    class Meta:
        db_table = 'user_profiles'  # Plural, snake_case

# Application-specific table prefixes
class ConfigSetting(models.Model):
    key = models.CharField(max_length=100)
    value = models.TextField()
    
    class Meta:
        db_table = 'app_config_settings'
```

### Best Practices for Table Naming

```python
# Consistent naming conventions
class DatabaseNamingExamples:
    """
    Best Practices:
    - Use snake_case for table names
    - Use plural names for tables (users, products, orders)
    - Be consistent across the project
    - Avoid using Django's default names in production
    - Consider database-specific limitations
    """
    
    # Good examples
    class User(models.Model):
        class Meta:
            db_table = 'users'
    
    class ProductCategory(models.Model):
        class Meta:
            db_table = 'product_categories'
    
    class OrderItem(models.Model):
        class Meta:
            db_table = 'order_items'
    
    # Legacy database integration
    class LegacyUser(models.Model):
        class Meta:
            db_table = 'tblUsers'  # Matching existing schema
            managed = False         # Django won't manage this table

# Complex naming scenario
class ComplexExample(models.Model):
    """
    For complex projects with multiple apps, consider:
    - app_prefix_tablename format
    - module_tablename format
    """
    
    class Meta:
        db_table = 'ecommerce_products'
        # or
        db_table = 'shop_products'
```

## Module 9: Creating A Django Model

### Step-by-Step Model Creation

```python
# Complete example: Blog application models
from django.db import models
from django.contrib.auth.models import User
from django.urls import reverse
from django.utils.text import slugify

class Category(models.Model):
    name = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(unique=True)
    description = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)
    
    def __str__(self):
        return self.name
    
    class Meta:
        verbose_name_plural = 'Categories'
        ordering = ['name']

class Tag(models.Model):
    name = models.CharField(max_length=50, unique=True)
    slug = models.SlugField(unique=True)
    
    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)
    
    def __str__(self):
        return self.name
    
    class Meta:
        ordering = ['name']

class Post(models.Model):
    # Status choices
    STATUS_CHOICES = [
        ('draft', 'Draft'),
        ('published', 'Published'),
        ('archived', 'Archived'),
    ]
    
    # Basic fields
    title = models.CharField(max_length=200)
    slug = models.SlugField(unique_for_date='publish_date')
    excerpt = models.TextField(max_length=500, blank=True)
    content = models.TextField()
    
    # Relationships
    author = models.ForeignKey(User, on_delete=models.CASCADE, related_name='posts')
    category = models.ForeignKey(Category, on_delete=models.SET_NULL, null=True, related_name='posts')
    tags = models.ManyToManyField(Tag, blank=True, related_name='posts')
    
    # Publication fields
    status = models.CharField(max_length=10, choices=STATUS_CHOICES, default='draft')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    publish_date = models.DateTimeField(null=True, blank=True)
    
    # SEO fields
    meta_title = models.CharField(max_length=200, blank=True)
    meta_description = models.TextField(max_length=300, blank=True)
    
    # Feature fields
    featured_image = models.ImageField(upload_to='posts/%Y/%m/', blank=True)
    featured = models.BooleanField(default=False)
    view_count = models.PositiveIntegerField(default=0)
    
    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.title)
        
        # Set publish date when status changes to published
        if self.status == 'published' and not self.publish_date:
            from django.utils import timezone
            self.publish_date = timezone.now()
        
        super().save(*args, **kwargs)
    
    def __str__(self):
        return self.title
    
    def get_absolute_url(self):
        return reverse('post_detail', kwargs={
            'year': self.publish_date.year,
            'month': self.publish_date.month,
            'day': self.publish_date.day,
            'slug': self.slug
        })
    
    @property
    def is_published(self):
        return self.status == 'published'
    
    def increment_view_count(self):
        self.view_count += 1
        self.save(update_fields=['view_count'])
    
    class Meta:
        ordering = ['-publish_date']
        indexes = [
            models.Index(fields=['status', 'publish_date']),
            models.Index(fields=['slug', 'publish_date']),
        ]
        get_latest_by = 'publish_date'
```

## Module 10: Generating & Reviewing the SQL

### Viewing Generated SQL

```bash
# Generate SQL for migrations
python manage.py sqlmigrate myapp 0001

# Show all SQL that would be executed
python manage.py migrate --dry-run --verbosity=3

# Check database schema
python manage.py dbshell
```

### Generated SQL Examples

```sql
-- Example SQL generated for a simple model
-- Model: 
-- class Product(models.Model):
--     name = models.CharField(max_length=100)
--     price = models.DecimalField(max_digits=10, decimal_places=2)
--     created_at = models.DateTimeField(auto_now_add=True)

-- Generated SQL (PostgreSQL):
CREATE TABLE "myapp_product" (
    "id" serial NOT NULL PRIMARY KEY,
    "name" varchar(100) NOT NULL,
    "price" numeric(10, 2) NOT NULL,
    "created_at" timestamp with time zone NOT NULL
);

-- SQL for model with relationships
-- class Order(models.Model):
--     customer = models.ForeignKey(Customer, on_delete=models.CASCADE)
--     product = models.ForeignKey(Product, on_delete=models.CASCADE)
--     quantity = models.IntegerField()

CREATE TABLE "myapp_order" (
    "id" serial NOT NULL PRIMARY KEY,
    "quantity" integer NOT NULL,
    "customer_id" integer NOT NULL,
    "product_id" integer NOT NULL,
    FOREIGN KEY ("customer_id") REFERENCES "myapp_customer" ("id") 
    DEFERRABLE INITIALLY DEFERRED,
    FOREIGN KEY ("product_id") REFERENCES "myapp_product" ("id") 
    DEFERRABLE INITIALLY DEFERRED
);

CREATE INDEX "myapp_order_customer_id" ON "myapp_order" ("customer_id");
CREATE INDEX "myapp_order_product_id" ON "myapp_order" ("product_id");
```

### Custom SQL in Migrations

```python
# Using RunSQL in migrations
from django.db import migrations

class Migration(migrations.Migration):
    dependencies = [
        ('myapp', '0001_initial'),
    ]
    
    operations = [
        migrations.RunSQL(
            sql='''
                ALTER TABLE myapp_product 
                ADD COLUMN search_vector tsvector;
                
                UPDATE myapp_product 
                SET search_vector = to_tsvector('english', name);
                
                CREATE INDEX product_search_idx 
                ON myapp_product USING gin(search_vector);
            ''',
            reverse_sql='''
                DROP INDEX IF EXISTS product_search_idx;
                ALTER TABLE myapp_product DROP COLUMN search_vector;
            ''',
        ),
    ]
```

## Module 11: Adding Data to the Model

### Creating Model Instances

```python
# Various ways to create model instances
from myapp.models import Product, Category, Order
from django.contrib.auth.models import User

# Method 1: Create and save separately
product = Product(name='Laptop', price=999.99)
product.save()

# Method 2: Create and save in one step
product = Product.objects.create(name='Mouse', price=29.99)

# Method 3: Using get_or_create to avoid duplicates
category, created = Category.objects.get_or_create(
    name='Electronics',
    defaults={'description': 'Electronic devices and accessories'}
)

# Method 4: Bulk creation for multiple objects
products = [
    Product(name='Keyboard', price=49.99),
    Product(name='Monitor', price=199.99),
    Product(name='Webcam', price=79.99),
]
Product.objects.bulk_create(products)

# Method 5: Using update_or_create
product, created = Product.objects.update_or_create(
    name='Laptop',
    defaults={'price': 899.99}  # Update price if exists
)
```

### Data Creation Examples

```python
# Complete data creation workflow
def create_sample_data():
    # Create categories
    electronics, _ = Category.objects.get_or_create(
        name='Electronics',
        slug='electronics'
    )
    books, _ = Category.objects.get_or_create(
        name='Books',
        slug='books'
    )
    
    # Create products
    laptop = Product.objects.create(
        name='Gaming Laptop',
        slug='gaming-laptop',
        price=1299.99,
        category=electronics,
        description='High-performance gaming laptop',
        stock_quantity=10
    )
    
    python_book = Product.objects.create(
        name='Python Programming',
        slug='python-programming',
        price=39.99,
        category=books,
        description='Learn Python programming',
        stock_quantity=25
    )
    
    # Create user and order
    user = User.objects.create_user(
        username='john_doe',
        email='john@example.com',
        password='password123'
    )
    
    order = Order.objects.create(
        customer=user,
        status='pending'
    )
    
    # Add items to order
    order.items.create(product=laptop, quantity=1)
    order.items.create(product=python_book, quantity=2)
    
    return order

# Using F() expressions for atomic updates
from django.db.models import F

def update_product_inventory(product_id, quantity_sold):
    # Atomic update to avoid race conditions
    Product.objects.filter(id=product_id).update(
        stock_quantity=F('stock_quantity') - quantity_sold
    )
```

## Module 12: Primary Keys and the Model

### Understanding Primary Keys

```python
# Default primary key behavior
class Product(models.Model):
    # Django automatically adds:
    # id = models.AutoField(primary_key=True)
    name = models.CharField(max_length=100)
    price = models.DecimalField(max_digits=10, decimal_places=2)

# Custom primary key
class Customer(models.Model):
    customer_id = models.CharField(
        max_length=10, 
        primary_key=True,
        unique=True
    )
    name = models.CharField(max_length=100)
    email = models.EmailField()

# UUID as primary key
import uuid
from django.db import models

class Order(models.Model):
    id = models.UUIDField(
        primary_key=True,
        default=uuid.uuid4,
        editable=False
    )
    order_date = models.DateTimeField(auto_now_add=True)
    total_amount = models.DecimalField(max_digits=10, decimal_places=2)

# Composite primary keys (not directly supported, use UniqueConstraint)
class OrderItem(models.Model):
    order = models.ForeignKey(Order, on_delete=models.CASCADE)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField()
    
    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=['order', 'product'],
                name='unique_order_product'
            )
        ]

# Working with primary keys
def primary_key_examples():
    # Create object with custom PK
    customer = Customer.objects.create(
        customer_id='CUST001',
        name='John Doe',
        email='john@example.com'
    )
    
    # Get object by primary key
    product = Product.objects.get(pk=1)
    customer = Customer.objects.get(pk='CUST001')
    order = Order.objects.get(pk=uuid.UUID('12345678-1234-5678-1234-567812345678'))
    
    # Using primary key in URLs
    def get_absolute_url(self):
        return reverse('product_detail', kwargs={'pk': self.pk})
```

## Module 13: Simple Data Retrieval Using a Model

### Basic Query Methods

```python
# Basic retrieval methods
from myapp.models import Product, Category

# Get all objects
all_products = Product.objects.all()

# Get single object by ID
product = Product.objects.get(id=1)

# Get single object or None
product = Product.objects.filter(id=1).first()

# Get or 404 (useful in views)
from django.shortcuts import get_object_or_404
product = get_object_or_404(Product, id=1)

# Count objects
product_count = Product.objects.count()

# Check if objects exist
has_products = Product.objects.exists()

# Basic filtering
expensive_products = Product.objects.filter(price__gt=100)
electronics = Product.objects.filter(category__name='Electronics')

# Chaining filters
available_electronics = Product.objects.filter(
    category__name='Electronics',
    available=True
)
```

### Retrieval Examples

```python
# Practical retrieval examples
def get_product_data():
    # Get specific fields only
    product_names = Product.objects.values_list('name', flat=True)
    product_details = Product.objects.values('id', 'name', 'price')
    
    # Get related objects
    products_with_category = Product.objects.select_related('category').all()
    
    # Limit results
    recent_products = Product.objects.order_by('-created_at')[:5]
    second_five_products = Product.objects.all()[5:10]
    
    # Distinct values
    categories = Product.objects.values_list('category__name', flat=True).distinct()
    
    # Aggregation
    from django.db.models import Avg, Max, Min, Sum
    price_stats = Product.objects.aggregate(
        avg_price=Avg('price'),
        max_price=Max('price'),
        min_price=Min('price'),
        total_value=Sum('price')
    )
    
    return {
        'names': list(product_names),
        'recent': list(recent_products),
        'stats': price_stats
    }

# Using in views
def product_list(request):
    products = Product.objects.filter(available=True).order_by('-created_at')
    categories = Category.objects.all()
    
    context = {
        'products': products,
        'categories': categories,
    }
    return render(request, 'products/list.html', context)
```

## Module 14: Understanding QuerySets

### QuerySet Fundamentals
QuerySets are lazy - they don't hit the database until they're evaluated.

```python
# QuerySet evaluation triggers
def queryset_evaluation():
    # These trigger database queries:
    list(Product.objects.all())           # Conversion to list
    for product in Product.objects.all(): # Iteration
    bool(Product.objects.all())           # Boolean context
    product = Product.objects.all()[0]    # Slicing with step
    len(Product.objects.all())            # Using len()
    
    # These don't trigger queries immediately:
    queryset = Product.objects.all()      # Assignment
    filtered = queryset.filter(price__gt=100)  # Chaining
    ordered = filtered.order_by('name')   # More chaining
    
    # The query happens here:
    results = list(ordered)               # Evaluation

# QuerySet caching
def queryset_caching():
    # First evaluation - hits database
    products = Product.objects.all()
    print(len(products))  # SQL executed
    
    # Second evaluation - uses cache
    print(len(products))  # No SQL
    
    # New QuerySet - new query
    expensive = products.filter(price__gt=100)
    print(len(expensive))  # New SQL
    
    # Re-evaluating original - uses cache
    print(len(products))  # No SQL
```

### QuerySet Methods

```python
# Common QuerySet methods
def queryset_methods():
    # Filtering
    available_products = Product.objects.filter(available=True)
    expensive_products = Product.objects.exclude(price__lt=100)
    
    # Ordering
    products_by_price = Product.objects.order_by('price')
    products_by_price_desc = Product.objects.order_by('-price')
    
    # Distinct
    unique_categories = Product.objects.values_list(
        'category__name', flat=True
    ).distinct()
    
    # Dates
    from datetime import datetime, timedelta
    recent_products = Product.objects.filter(
        created_at__gte=datetime.now() - timedelta(days=7)
    )
    
    # Complex lookups
    from django.db.models import Q
    featured_or_expensive = Product.objects.filter(
        Q(featured=True) | Q(price__gt=500)
    )
```

## Module 15: Applying Filters

### Filter Conditions and Lookups

```python
# Basic filter examples
def basic_filters():
    # Exact match
    product = Product.objects.get(name='Laptop')
    
    # Case-insensitive match
    product = Product.objects.filter(name__iexact='laptop')
    
    # Contains
    laptops = Product.objects.filter(name__contains='Laptop')
    
    # Startswith/endswith
    apple_products = Product.objects.filter(name__startswith='Apple')
    
    # In list
    categories = ['Electronics', 'Books']
    products = Product.objects.filter(category__name__in=categories)
    
    # Range
    from datetime import datetime, timedelta
    last_week = datetime.now() - timedelta(days=7)
    recent_products = Product.objects.filter(
        created_at__range=[last_week, datetime.now()]
    )
    
    # Null checks
    products_with_description = Product.objects.exclude(description__isnull=True)

# Related field filters
def related_filters():
    # ForeignKey lookups
    electronics_products = Product.objects.filter(category__name='Electronics')
    
    # Many-to-Many lookups
    featured_products = Product.objects.filter(tags__name='featured')
    
    # Reverse relationship lookups
    from django.contrib.auth.models import User
    users_with_products = User.objects.filter(products__isnull=False).distinct()
    
    # Complex related lookups
    expensive_electronics = Product.objects.filter(
        category__name='Electronics',
        price__gt=1000
    )
```

## Module 16: Specifying Field Lookups

### Field Lookup Types

```python
# Complete field lookup reference
def field_lookup_examples():
    # Exact matches
    Product.objects.filter(name__exact='Laptop')
    Product.objects.filter(name='Laptop')  # shorthand
    
    # String lookups
    Product.objects.filter(name__iexact='laptop')      # case-insensitive
    Product.objects.filter(name__contains='apple')     # contains
    Product.objects.filter(name__icontains='apple')    # case-insensitive contains
    Product.objects.filter(name__startswith='Mac')     # starts with
    Product.objects.filter(name__istartswith='mac')    # case-insensitive start
    Product.objects.filter(name__endswith='Pro')       # ends with
    Product.objects.filter(name__iendswith='pro')      # case-insensitive end
    Product.objects.filter(name__regex=r'^[A-Z]')      # regex match
    Product.objects.filter(name__iregex=r'^[a-z]')     # case-insensitive regex
    
    # Numeric lookups
    Product.objects.filter(price__gt=100)        # greater than
    Product.objects.filter(price__gte=100)       # greater than or equal
    Product.objects.filter(price__lt=50)         # less than
    Product.objects.filter(price__lte=50)        # less than or equal
    Product.objects.filter(price__range=(10, 100))  # between range
    
    # Date lookups
    from datetime import date
    Product.objects.filter(created_at__date=date.today())
    Product.objects.filter(created_at__year=2023)
    Product.objects.filter(created_at__month=12)
    Product.objects.filter(created_at__day=25)
    Product.objects.filter(created_at__week=52)
    Product.objects.filter(created_at__week_day=1)  # Sunday=1, Saturday=7
    
    # Time lookups
    Product.objects.filter(created_at__time__hour=9)
    Product.objects.filter(created_at__time__minute=30)
    
    # Null and boolean lookups
    Product.objects.filter(description__isnull=True)
    Product.objects.filter(available__isnull=False)
    Product.objects.filter(featured=True)
```

## Module 17: Lookup Types

### Advanced Lookup Techniques

```python
# Complex lookup combinations
def advanced_lookups():
    from django.db.models import Q, F
    
    # OR conditions with Q objects
    featured_or_expensive = Product.objects.filter(
        Q(featured=True) | Q(price__gt=1000)
    )
    
    # AND conditions
    featured_and_available = Product.objects.filter(
        Q(featured=True) & Q(available=True)
    )
    
    # NOT conditions
    not_electronics = Product.objects.filter(~Q(category__name='Electronics'))
    
    # Complex combinations
    complex_query = Product.objects.filter(
        (Q(featured=True) | Q(price__lt=50)) & 
        Q(available=True) &
        ~Q(category__name='Books')
    )
    
    # F expressions for comparing fields
    popular_products = Product.objects.filter(view_count__gt=F('stock_quantity'))
    
    # Using F expressions in updates
    Product.objects.filter(view_count__lt=100).update(
        view_count=F('view_count') + 10
    )
```

## Module 18: Slicing QuerySets

### Limiting Query Results

```python
# Slicing and limiting QuerySets
def slicing_examples():
    # Basic slicing (supports Python slicing syntax)
    first_5_products = Product.objects.all()[:5]           # LIMIT 5
    products_6_to_10 = Product.objects.all()[5:10]         # OFFSET 5 LIMIT 5
    last_5_products = Product.objects.order_by('-id')[:5]  # Last 5
    
    # Slicing doesn't work with negative indices
    # This WON'T work:
    # last_product = Product.objects.all()[-1]
    
    # Correct way to get last object
    last_product = Product.objects.order_by('-id').first()
    
    # Step slicing (not efficient for large datasets)
    every_second_product = Product.objects.all()[::2]
    
    # Pagination example
    def get_products_page(page_number=1, page_size=10):
        start = (page_number - 1) * page_size
        end = start + page_size
        return Product.objects.all()[start:end]
    
    # Check if there are more results
    def has_next_page(page_number, page_size):
        total = Product.objects.count()
        return (page_number * page_size) < total

# Efficient slicing for large datasets
def efficient_slicing():
    # Use specific ordering for consistent slicing
    recent_products = Product.objects.order_by('-created_at')[:10]
    
    # Use IDs for efficient pagination
    last_id = 100  # From previous page
    next_page = Product.objects.filter(id__gt=last_id).order_by('id')[:10]
    
    # Use dates for time-based slicing
    from datetime import datetime, timedelta
    last_week = datetime.now() - timedelta(days=7)
    recent = Product.objects.filter(created_at__gte=last_week).order_by('-created_at')
```

## Module 19: Specifying Ordering in QuerySets

### Ordering Results

```python
# Ordering examples
def ordering_examples():
    # Single field ordering
    products_by_name = Product.objects.order_by('name')
    products_by_price_desc = Product.objects.order_by('-price')
    
    # Multiple field ordering
    products_by_category_and_price = Product.objects.order_by(
        'category__name', '-price'
    )
    
    # Random ordering (not efficient for large datasets)
    random_products = Product.objects.order_by('?')[:5]
    
    # Case-insensitive ordering
    from django.db.models.functions import Lower
    products_ci = Product.objects.order_by(Lower('name'))
    
    # Custom ordering with expressions
    from django.db.models import F, Value
    from django.db.models.functions import Coalesce
    
    # Order by discounted price (price - discount)
    discounted_products = Product.objects.annotate(
        discounted_price=F('price') - F('discount')
    ).order_by('discounted_price')
    
    # Order with nulls last
    products_with_nulls = Product.objects.order_by(
        Coalesce('description', Value('')).asc()
    )

# Default ordering in models
class Product(models.Model):
    name = models.CharField(max_length=100)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-created_at']  # Default ordering for this model
        
    # Override default ordering in queries
    def get_products_sorted_by_price():
        return Product.objects.all().order_by('price')  # Overrides Meta.ordering
```

## Module 20: Common QuerySet Methods

### Essential QuerySet Methods

```python
# Most commonly used QuerySet methods
def common_queryset_methods():
    # Aggregation methods
    from django.db.models import Count, Avg, Sum, Max, Min
    
    # Count
    total_products = Product.objects.count()
    available_count = Product.objects.filter(available=True).count()
    
    # Aggregate
    stats = Product.objects.aggregate(
        total=Count('id'),
        avg_price=Avg('price'),
        max_price=Max('price'),
        total_value=Sum('price')
    )
    
    # Annotate (add computed fields to each object)
    from django.db.models import F
    products_with_discount = Product.objects.annotate(
        discounted_price=F('price') * 0.9
    )
    
    # Values and values_list (get specific fields)
    product_names = Product.objects.values_list('name', flat=True)
    product_data = Product.objects.values('id', 'name', 'price')
    
    # Select related (optimize foreign key queries)
    products_with_category = Product.objects.select_related('category').all()
    
    # Prefetch related (optimize many-to-many queries)
    products_with_tags = Product.objects.prefetch_related('tags').all()
    
    # Distinct
    unique_categories = Product.objects.values_list(
        'category__name', flat=True
    ).distinct()
    
    # Extra (for custom SQL)
    featured_products = Product.objects.extra(
        where=["featured = TRUE AND available = TRUE"]
    )
```

## Module 21: Deleting Records

### Delete Operations

```python
# Deleting objects
def delete_examples():
    # Delete single object
    product = Product.objects.get(id=1)
    product.delete()  # Returns number of objects deleted
    
    # Delete multiple objects
    Product.objects.filter(available=False).delete()
    
    # Delete all objects (use with caution!)
    Product.objects.all().delete()
    
    # Safe delete with confirmation
    def safe_delete_product(product_id):
        try:
            product = Product.objects.get(id=product_id)
            if product.stock_quantity == 0:
                product.delete()
                return True
            return False
        except Product.DoesNotExist:
            return False
    
    # Soft delete pattern (recommended)
    class SoftDeleteModel(models.Model):
        is_active = models.BooleanField(default=True)
        deleted_at = models.DateTimeField(null=True, blank=True)
        
        def delete(self, *args, **kwargs):
            self.is_active = False
            self.deleted_at = timezone.now()
            self.save()
        
        class Meta:
            abstract = True
    
    class Product(SoftDeleteModel):
        name = models.CharField(max_length=100)
        # ... other fields
        
        # Manager for active objects only
        objects = models.Manager()
        active_objects = models.Manager().filter(is_active=True)
```

## Module 22: Managing Related Records

### Working with Relationships

```python
# Managing foreign key relationships
def foreign_key_management():
    # Creating with foreign key
    category = Category.objects.get(name='Electronics')
    product = Product.objects.create(
        name='Smartphone',
        category=category,  # Set foreign key
        price=699.99
    )
    
    # Updating foreign key
    new_category = Category.objects.get(name='Phones')
    product.category = new_category
    product.save()
    
    # Accessing related objects
    product_category = product.category  # Forward relation
    category_products = category.products.all()  # Reverse relation
    
    # Using related_name
    class Product(models.Model):
        category = models.ForeignKey(
            Category, 
            on_delete=models.CASCADE,
            related_name='products'  # Custom reverse relation name
        )
    
    # Now we can use:
    electronics_products = category.products.all()

# Managing many-to-many relationships
def many_to_many_management():
    # Creating objects with M2M
    product = Product.objects.create(name='Laptop', price=999.99)
    tag1 = Tag.objects.create(name='electronics')
    tag2 = Tag.objects.create(name='gaming')
    
    # Adding relationships
    product.tags.add(tag1, tag2)  # Add multiple at once
    product.tags.add(tag1)        # Add single
    
    # Removing relationships
    product.tags.remove(tag1)     # Remove specific
    product.tags.clear()          # Remove all
    
    # Checking relationships
    has_electronics = product.tags.filter(name='electronics').exists()
    
    # Through model for extra data
    class ProductTag(models.Model):
        product = models.ForeignKey(Product, on_delete=models.CASCADE)
        tag = models.ForeignKey(Tag, on_delete=models.CASCADE)
        added_by = models.ForeignKey(User, on_delete=models.CASCADE)
        added_at = models.DateTimeField(auto_now_add=True)
```

## Module 23: Retrieving Related Records

### Efficient Related Object Retrieval

```python
# Optimizing related object queries
def efficient_related_queries():
    # Problem: N+1 query issue
    products = Product.objects.all()  # 1 query
    for product in products:
        print(product.category.name)  # N queries (one per product)
    
    # Solution: select_related (for ForeignKey, OneToOne)
    products = Product.objects.select_related('category').all()  # 1 query
    for product in products:
        print(product.category.name)  # 0 queries (already loaded)
    
    # Solution: prefetch_related (for ManyToMany, reverse ForeignKey)
    products = Product.objects.prefetch_related('tags').all()  # 2 queries
    for product in products:
        print([tag.name for tag in product.tags.all()])  # 0 queries
    
    # Complex prefetching
    from django.db.models import Prefetch
    
    # Prefetch with filtering
    featured_tags = Tag.objects.filter(featured=True)
    products = Product.objects.prefetch_related(
        Prefetch('tags', queryset=featured_tags, to_attr='featured_tags')
    )
    
    # Multiple relationships
    products = Product.objects.select_related('category').prefetch_related('tags')
    
    # Nested prefetching
    categories = Category.objects.prefetch_related(
        Prefetch('products', queryset=Product.objects.select_related('supplier'))
    )
```

## Module 24: Using Q Objects

### Complex Query Conditions

```python
# Advanced querying with Q objects
from django.db.models import Q

def q_object_examples():
    # Basic OR query
    electronics_or_books = Product.objects.filter(
        Q(category__name='Electronics') | Q(category__name='Books')
    )
    
    # AND query
    featured_electronics = Product.objects.filter(
        Q(category__name='Electronics') & Q(featured=True)
    )
    
    # NOT query
    not_books = Product.objects.filter(~Q(category__name='Books'))
    
    # Complex combinations
    complex_query = Product.objects.filter(
        (Q(price__lt=100) | Q(featured=True)) & 
        Q(available=True) &
        ~Q(category__name='Accessories')
    )
    
    # Dynamic Q object building
    def build_search_query(search_terms, categories, min_price, max_price):
        query = Q()
        
        if search_terms:
            for term in search_terms:
                query |= Q(name__icontains=term) | Q(description__icontains=term)
        
        if categories:
            category_query = Q()
            for category in categories:
                category_query |= Q(category__name=category)
            query &= category_query
        
        if min_price is not None:
            query &= Q(price__gte=min_price)
        
        if max_price is not None:
            query &= Q(price__lte=max_price)
        
        return Product.objects.filter(query)
    
    # Using Q objects with annotations
    from django.db.models import Case, When, Value, IntegerField
    
    featured_priority = Product.objects.annotate(
        priority=Case(
            When(Q(featured=True) & Q(available=True), then=Value(1)),
            When(Q(available=True), then=Value(2)),
            default=Value(3),
            output_field=IntegerField(),
        )
    ).order_by('priority', 'name')
```

### Practical Q Object Applications

```python
# Real-world Q object scenarios
class ProductQuerySet(models.QuerySet):
    def available(self):
        return self.filter(available=True)
    
    def featured(self):
        return self.filter(featured=True)
    
    def search(self, query):
        if not query:
            return self.all()
        
        return self.filter(
            Q(name__icontains=query) |
            Q(description__icontains=query) |
            Q(category__name__icontains=query)
        )
    
    def price_range(self, min_price=None, max_price=None):
        q = Q()
        if min_price is not None:
            q &= Q(price__gte=min_price)
        if max_price is not None:
            q &= Q(price__lte=max_price)
        return self.filter(q)
    
    def by_categories(self, categories):
        if not categories:
            return self.all()
        
        category_query = Q()
        for category in categories:
            category_query |= Q(category__name=category)
        
        return self.filter(category_query)

# Custom manager
class ProductManager(models.Manager):
    def get_queryset(self):
        return ProductQuerySet(self.model, using=self._db)
    
    def available(self):
        return self.get_queryset().available()
    
    def search(self, query):
        return self.get_queryset().search(query)
    
    def featured_products(self):
        return self.get_queryset().available().featured()

# Usage in model
class Product(models.Model):
    # ... fields ...
    
    objects = ProductManager()
    
    # Usage examples:
    # Product.objects.search("laptop").price_range(500, 1500)
    # Product.objects.available().by_categories(['Electronics', 'Books'])
```

This comprehensive Week 6 module covers Django database models in depth, providing students with the knowledge needed to design, create, and manage database structures effectively using Django's ORM. Each section builds upon previous concepts, creating a solid foundation for database operations in Django web applications.